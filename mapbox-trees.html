<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@esri/arcgis-rest-request@3.0.0/dist/umd/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-auth@3.0.0/dist/umd/auth.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-layer@3.0.0/dist/umd/feature-layer.umd.js"></script>
    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }
      .map-overlay {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.8);
        margin-right: 20px;
        font-family: Arial, sans-serif;
        overflow: auto;
        border-radius: 3px;
      }
      
        #legend {
        padding: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 18px;
        height: 150px;
        margin-top: 40px;
        width: 100px;
      }
      .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }
      
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div class='map-overlay' id='legend'><p><b>Tree health</b></p></div>

    <script>

     const apiKey = 'AAPK2a1977cfc1a44f6ca6a44369714e03dcltUEQxZ9zaxhJDjmMjhdqtJp5mW3V9h8ZpKV6G7qyTWv9ANGQEKcJomtCPknR8hE';
      const basemapEnum = "c26fe994fd1a4fb3978f6c07e5590aef"
      
      const map = new mapboxgl.Map({
        container: "map", 
        style: `https://basemaps-api.arcgis.com/arcgis/rest/services/styles/${basemapEnum}?type=style&apiKey=${apiKey}`,
        zoom: 10,
        center:  [-122.6750, 45.5051]
      });
     const layers = [
      {
      "id": "treefair",
      "type": "circle",
      "source": "pdx",
      "source-layer": "PDX Trees",
      "filter": [
        "==",
        "_symbol",
        0
      ],
      "layout": {

      },
      "paint": {
        "circle-color": "#9E559C",
        "circle-radius": {
            "stops": [
               [2, 10],
               [5, 8],
              [10, 4]
            ]
        }
      }
    },
    {
      "id": "treegood",
      "type": "circle",
      "source": "pdx",
      "source-layer": "PDX Trees",
      "filter": [
        "==",
        "_symbol",
        1
      ],
      "layout": {

      },
      "paint": {
        "circle-color": "#A7C636",
        "circle-radius": 4
      }
    },
    {
      "id": "treepoor",
      "type": "circle",
      "source": "pdx",
      "source-layer": "PDX Trees",
      "filter": [
        "==",
        "_symbol",
        2
      ],
      "layout": {

      },
      "paint": {
        "circle-color": "#149ECE",
        "circle-radius": 4
      }
    },
    {
      "id": "treedead",
      "type": "circle",
      "source": "pdx",
      "source-layer": "PDX Trees",
      "filter": [
        "==",
        "_symbol",
        3
      ],
      "layout": {

      },
      "paint": {
        "circle-color": "#ED5151",
        "circle-radius": 4,
      }
    }
  ]
      map.once("load", () => {

    map.addSource("pdx", {
        type: "vector",
        tiles: ["https://vectortileservices8.arcgis.com/87xMVlxSyDt491tZ/arcgis/rest/services/PDX_Trees/VectorTileServer/tile/{z}/{y}/{x}.pbf"]
      });

  layers.forEach((lyr)=>{
        map.addLayer(lyr);
      });
        

      const popup = new mapboxgl.Popup({
        closeButton: false
      });
        
      map.on('mousemove', 'treefair', (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const feature = e.features[0];
        const relatedFeatures = map.querySourceFeatures('treefair', {
          sourceLayer: 'PDX Trees',
          filter: ['in', 'Common', feature.properties.Common]
        });
        
       popup.setLngLat(e.lngLat).setHTML(`<b>Common Name: ${feature.properties.Common}</b>`).addTo(map);
      })
        
        map.on('mouseleave', 'treefair', (e)=>{
          map.getCanvas().style.cursor = '';
            popup.remove();
         
        })
        
              map.on('mousemove', 'treepoor', (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const feature = e.features[0];
        const relatedFeatures = map.querySourceFeatures('treedead', {
          sourceLayer: 'PDX Trees',
          filter: ['in', 'Common', feature.properties.Common]
        });
        
       popup.setLngLat(e.lngLat).setHTML(`<b>Common Name: ${feature.properties.Common}</b>`).addTo(map);
      })
        
        map.on('mouseleave', 'treefair', (e)=>{
          map.getCanvas().style.cursor = '';
            popup.remove();
         
        })
        
        

     const conditions= ["Good", "Fair", "Poor", "Dead"];
    const colors = ["#A7C636","#9E559C", "#149ECE","#ED5151" ]
   
    for (i = 0; i < conditions.length; i++) {
    const layer = conditions[i];
      const color = colors[i];
      const item = document.createElement('div');
      const key = document.createElement('span');
      key.className = 'legend-key';
      key.style.backgroundColor = color;

      var value = document.createElement('span');
      value.innerHTML = layer;
      item.appendChild(key);
      item.appendChild(value);
      legend.appendChild(item);
    
  
    }
        
     });
      


    </script>

  </body>
</html>

